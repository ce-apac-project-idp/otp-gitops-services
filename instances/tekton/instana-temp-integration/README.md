# README

# Aside

Please note you will find all these resources (Tasks, pipelines, configmaps etc..) in the "backstage" namespace, NOT "tekton".


# Procedure

The relevant artefacts can be found in the task and pipeline folder. 

In order, the pipeline executes the following:

1) bp-task
2) image-checker
3) image-scanner
4) image-deployer


Bp-task executes the following:

1) Creates a build config pertaining to the app (if necessary) and uses the provided params in addition to the configmap workspace (this is a configmap called registry-data) to populate the build config. This will contain the output docker registry and the input Dockerfile source, in addition to pointers to the k8 secrets required to pull and push from the git repo and docker registry respectively. There is a dummy buildconfig file baked in the image and I use yq to perform the substitutions. I start and wait for the build to finish. Once the build is commplete I query the relevant build to obtain the image and sha, which are passed to the downstream tasks.

An example BuildConfig and build generated by this task can be found in the samples directory.

Image-checker executes the following:

1) Performs a roxctl image check using the image and sha obtained from the upstream task.
2) The roxctl binary is baked into the image, so no curl'ing required here, nor is the utility used to obtain the SHA.

Image-scanner is very similar to the above task, except the scan command, as opposed to check, is run.

Image-deployer executes the following:

1) The task will create a deployment.yaml using the image and sha obtained from earlier tasks. (Yes I need to mmaking services and routes as well but this is to be done later)
2) It will then push this
3) It uses the git-data configmap which contains info about the git repo to push to. (ArgoCD then takes care of the rest from there)

An example pipelinerun can be found in the samples directory too.


# Additional Information

## ConfigMap/Secret Injection

Hardcoded values should be avoided where possible, please externalise non sensitive values to configmaps and sensitive values as secrets. Assumming we have a bunch of values we wish to externalise (Say, instana_server and instana_endpoint in the tekton task) we can include them within a configmap called "instana-data" (Recall I have a git-data and registry-data configmap as well for the same purpose)

Introduce them to as a entry in the workspaces stanza of pipeline.yaml. You will notice that there is a pipeline directory in this folder. the Workspaces stanza contains, amongst others, the aforementioned reg-data and git-data configmaps referred to, within the context of the pipeline, as registry-configmap and git-configmap respectively.

They are "referenced" in the pipelinerun object. I have provided a pipelinerun spec in the samples directory. Look at the workspaces stanza. Registry-data and git-data are defined there and mapped to the registry-configmap and git-configmap respectively.

Referencing them in the tasks is quite simple. Look at "bp-task" within the task directory. Specifically, lines 85-88 (inclusive). Each parameter is defined in a file found within /workspace/name_of_cmap/name_of_parameter_here. 

Please take care with name_of_cmap_here, this is the name of the cmap **within the scope of the task**. Look at lines 11 and 12 of this very task. The name is defined there on the task level and defined in line 44 at the pipeline level.

The same can be applied for secrets.
